# 清理木马

## 查杀病毒进程

`cpu`占用率如此之高，基本可判断为挖矿程序无疑了，使用在线威胁情报系统对进程进行检测，不出所料，得出的标签是`coinminer`。

这种挖矿进程一般都有自动重启机制，可能是某个进程的子进程，也可能在`cron`定时任务里出现。

首先，检查`cron`定时任务，发现`/var/spool/cron/crontabs/root`和`/etc/cron.d/tomcat`文件修改时间有变化，但是内容却无改动。

然后，使用`ps -ef`进行查找主进程，并无收获。
同时发现此挖矿进程正在和`172.105.114.84`这个ip的`8443`端口进行通信，可能是黑客的一台远控服务器。

之后，`lsof`查看此进程在操作哪些文件，也无实际收获。

推测一定是有某个主进程在工作，继续通过`ps`和`netstat`查找监听所监听端口的异常。
果不其然，看到异常进程，正在批量爆破，看来是被当做肉鸡了。
同时使用`lsof`查看此进程文件，发现在调用`/root/.ddg/4003.db`文件，貌似是个加密的社工库。

判断是此程序即是主程序，`kill`掉挖矿进程后，使用`strace -T -tt -e strace=full`进行跟踪，发现主进程先对挖矿进程增加可执行权限，之后拉起进程。

那么现在kill掉主进程吧，发生个小插曲，发现主进程`pid`一直在变化，好吧，直接`killall osryfa3`

至此，算是暂时消停一下，简单总结一下此病毒特征，其一方面释放挖矿病毒进行挖矿，同时又对公网ssh服务进行爆破以扩大感染面。在这里同时给了我一个提醒，或许这台服务器就是通过ssh爆破被入侵的。

### 查找入侵痕迹

一般情况下，入侵可能有以下几种方式：

1. 各种弱口令爆破

2. 系统漏洞的利用

3. 应用漏洞的利用

查看登录日志，发现异常(下图是已经过滤掉正常登录的日志)，基本可断定是通过ssh爆破入侵了，也可以断定ssh的访问控制已经失效。

`cat /var/log/secure* | grep Accepted`

结合以上`ip`查看爆破日志，确认以上`ip`的用户不是同一个人，是刚好有这么多`ip`同时爆破了`root`账户，而且最短的爆破时间只花了`1`分钟。想来这个`root`账户必然是个弱密码了。

继续查找`Failed`日志的最早时间如下：

 `cat /var/log/secure* | grep Failed`

基本可断定在这之前有人动过访问控制策略了，询问运维人员无果。

> `stats`查看`iptables`、`/etc/hosts.allow和/etc/hosts.deny`文件状态，结合`.bash_history`命令，一切真相大白

## 病毒文件的清理

1. 使用`stat`查看上面两个进程的修改时间

2. 结合这两个时间来查找敏感目录中被修改过的系统文件，进行检查修复和清除。

    `find /etc/ /usr/bin/ /usr/sbin/ /bin/ /usr/local/bin/ /var/spool/cron/ -type f -mtime -3 | xargs ls -l`

3. 使用`chkrootkit`、`clamav`、`rkhunter`一通查杀，当然，还是重装系统最保险。

## 总结
