# Redis 分区

分区是分割数据到多个Redis实例的处理过程，因此每个实例只保存`key`的一个子集。

## 分区的优势

1. 通过利用多台计算机内存的和值，允许构造更大的数据库。

2. 通过多核和多台计算机，允许扩展计算能力；
3. 通过多台计算机和网络适配器，允许扩展网络带宽。

## 分区的不足

redis的一些特性在分区方面表现的不是很好：

1. 涉及多个key的操作通常是不被支持的。
    举例来说，当两个set映射到不同的redis实例上时，就不能对这两个set执行交集操作。
2. 涉及多个key的redis事务不能使用。
    当使用分区时，数据处理较为复杂，比如需要处理多个`rdb/aof`文件，并且从多个实例和主机备份持久化文件。
3. 增加或删除容量也比较复杂。
    redis集群大多数支持在运行时增加、删除节点的透明数据平衡的能力，但是类似于客户端分区、代理等其他系统则不支持这项特性。然而，一种叫做`presharding`的技术对此是有帮助的。

## 分区类型

Redis 有两种类型分区 
    
假设有4个Redis实例 `R0，R1，R2，R3`
和类似`user:1，user:2`这样的表示用户的多个`key`
对既定的`key`有多种不同方式来选择这个`key`存放在哪个实例中。
> 也就是说，有不同的系统来映射某个`key`到某个`Redis`服务。

### 范围分区

最简单的分区方式是按范围分区，就是映射一定范围的对象到特定的Redis实例。

比如，ID从`0到10000`的用户会保存到实例`R0`，ID从`10001到 20000`的用户会保存到R1，以此类推。

这种方式是可行的，并且在实际中使用，不足就是要有一个区间范围到实例的**映射表**。

> 这个表要被管理，同时还需要各种对象的映射表，通常对`Redis`来说并非是最好的方法。

### 哈希分区(漂亮)

另外一种分区方法是`hash`分区

这对`任何key`都适用，也无需是`object_name:`这种形式

> 将索引的key转换成数字然后进行取模处理,进行分区

像下面描述的一样简单：

1. 用一个`hash`函数将`key`转换为一个数字
    比如使用`crc32`hash函数。

2. 对key `foobar`执行`crc32(foobar)`会输出类似`93024922`的整数。
3. 对这个整数取模，将其转化为`0-3`之间的数字，就可以将这个整数映射到`4个Redis实例`中的一个了。
    `93024922 % 4 = 2`，就是说key `foobar`应该被存到R2实例中。
    
> 注意：取模操作是取除的余数，通常在多种编程语言中用`%`操作符实现。